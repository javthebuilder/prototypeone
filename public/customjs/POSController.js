angular.module("app",["AppServices"]).constant("API_URL","/pos").config(["$httpProvider",function(t){t.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).controller("POSController",["$http","API_URL","PNotifyFactory","SQLSTATEFactory","PersonaFactory","DiscountsFactory","ProductsFactory","GlobalFactory","PaymentsFactory",function(t,s,e,o,a,n,i,r,l){var c=this;$("#searchitems").focus(),c.companyvat=$("#companyvat").val(),c.category="",c.searchitems="",c.pagination={},$("#maincontainer").prop("hidden",!0),$("#loading").prop("hidden",!1),location.href.indexOf("tercet.co"),c.init=function(){c.lastsalesmstr={},c.lastsalesdtl={},c.pk_salesmstr=-1,c.salesmstr={},c.salesdtl=[],c.fk_persons=null,c.payername="",$("#fk_persons").val(null),$("#fk_persons").trigger("change"),c.fk_discounts=null,c.discrate=0,c.discountname="*Not Applicable*",$("#fk_discounts").val(null),$("#fk_discounts").trigger("change"),c.subtotal=0,c.totaltax=0,c.totaldiscount=0,c.netamount=0,r.configLoadingPOSTransactions("off",c)},c.filterCollapseCheckbox=!1,$("#filterCollapseCheckbox").click(function(){c.filterCollapseCheckbox=!c.filterCollapseCheckbox,c.filterCollapseCheckbox?$("#divitemlist").prop("hidden",!0):$("#divitemlist").prop("hidden",!1)}),a.SearchPersona("#fk_persons","customer",c),n.SearchDiscount("#fk_discounts",c),$("#pk_salesmstr").change(function(){c.pk_salesmstr=$("#pk_salesmstr").val(),c.loadTransaction()}),$("#NewTransaction").click(function(){c.issubmitting||(PNotify.removeAll(),r.configLoadingPOSTransactions("on",c),t.post(s+"/create",{companyvat:c.companyvat}).then(function(t){var s=t.data;"no selected store"!=s&&Object.keys(s).length>0?(c.pk_salesmstr=s.pk_salesmstr,c.salesmstr=s,c.salesdtl=[],$("#pk_salesmstr").append('<option value="'+s.pk_salesmstr+'">'+s.trxdescription+"</option>").val(s.pk_salesmstr).trigger("change"),c.setSelect2Value(s,"fk_persons"),c.setSelect2Value(s,"fk_discounts"),c.setSubTotal(c.salesmstr)):new PNotify({title:"Session Store is Empty!",text:'Click <a href="/home"> Home </a> to configure RESTO POS',type:"error"}),r.configLoadingPOSTransactions("off",c)},function(t){new PNotify({title:"Error(s) found!",text:"please see logs for details",type:"error"}),console.log(t.data),r.configLoadingPOSTransactions("off",c)}))}),$("#fk_persons").change(function(){PNotify.removeAll(),c.issubmitting||c.isOpenTransaction()&&(c.fk_persons=$("#fk_persons").val(),c.payername=$("#fk_persons option[value='"+c.fk_persons+"'").text(),r.configLoadingPOSTransactions("on",c),t.post(s+"/update/"+c.pk_salesmstr+"?iscustomer=1",{fk_persons:c.fk_persons,payername:c.payername}).then(function(t){var s=t.data;"no transaction"!=s&&Object.keys(s).length>0?$('#pk_salesmstr option[value="'+c.pk_salesmstr+'"]').text(s[0].trxdescription):c.transactionIsClose(),r.configLoadingPOSTransactions("off",c)},function(t){new PNotify({title:"Error(s) found!",text:"please see logs for details",type:"error"}),console.log(t.data),r.configLoadingPOSTransactions("off",c)}))}),$("#fk_discounts").change(function(){PNotify.removeAll(),c.issubmitting||c.isOpenTransaction()&&(c.fk_discounts=$("#fk_discounts").val(),c.discrate=0,c.discountname="*Not Applicable*",c.mscDiscountRate.forEach(function(t,s){t.pk_discounts==c.fk_discounts&&(c.discrate=t.rate,c.discountname=t.description)}),r.configLoadingPOSTransactions("on",c),t.post(s+"/update/"+c.pk_salesmstr+"?isdiscount=1",{fk_discounts:c.fk_discounts,discrate:c.discrate}).then(function(t){var s=t.data;"no transaction"!=s&&Object.keys(s).length>0?(c.salesmstr=s.salesmstr[0],c.salesdtl=s.salesdtl,c.setSubTotal(c.salesmstr)):c.transactionIsClose(),r.configLoadingPOSTransactions("off",c)},function(t){new PNotify({title:"Error(s) found!",text:"please see logs for details",type:"error"}),console.log(t.data),r.configLoadingPOSTransactions("off",c)}))}),c.initPagination=function(t){c.pagination={current_page:t.current_page,first_page_url:t.first_page_url,from:t.from,last_page:t.last_page,last_page_url:t.last_page_url,next_page_url:t.next_page_url,path:t.path,per_page:t.per_page,prev_page_url:t.prev_page_url,to:t.to,total:t.total}},c.loadDependencies=function(){t.get(s+"/searchitems?load=onload",{}).then(function(t){var s=t.data.products;c.initPagination(s),c.productlist=s.data,c.pk_salesmstr=null,c.pk_salesmstr=null,$("#pk_salesmstr").val(-1),$("#pk_salesmstr").trigger("change"),$("#maincontainer").prop("hidden",!1),$("#loading").prop("hidden",!0)},function(t){new PNotify({title:"Error(s) found!",text:"please see logs for details",type:"error"}),console.log(t.data)})},c.loadTransaction=function(){PNotify.removeAll(),c.issubmitting||(r.configLoadingPOSTransactions("on",c),t.get(s+"/show/"+c.pk_salesmstr+"?type=open",{}).then(function(t){var s=t.data;s.salesmstr.length>0?(c.salesmstr=s.salesmstr[0],c.salesdtl=s.salesdtl,c.setSelect2Value(c.salesmstr,"fk_persons"),c.setSelect2Value(c.salesmstr,"fk_discounts"),c.setSubTotal(c.salesmstr)):c.transactionIsClose(),r.configLoadingPOSTransactions("off",c)},function(t){new PNotify({title:"Error(s) found!",text:"please see logs for details",type:"error"}),console.log(t.data),r.configLoadingPOSTransactions("off",c)}))},c.SearchCategory=function(){i.SearchProducts(s+"/searchitems?search="+c.searchitems+"&category="+c.category,t,c,"searchcategory")},c.SearchBarcode=function(){i.SearchProducts(s+"/searchitems?search="+c.searchbarcode+"&type=barcode",t,c,"searchbarcode")},c.SearchProducts=function(){i.SearchProducts(s+"/searchitems?search="+c.searchitems,t,c,"searchitem")},c.paginateList=function(s){i.SearchProducts(s+"&search="+c.searchitems,t,c,"searchitem")},c.AddItem=function(e,o,a){c.issubmitting||c.isOpenTransaction()&&(PNotify.removeAll(),r.configLoadingPOSTransactions("on",c),t.post(s+"/additems/"+c.pk_salesmstr,{pk_products:e.pk_products,qty:o,input:a}).then(function(t){var s=t.data;"no transaction"!=s?"item not found"!=s?"out of stock"!=s&&Object.keys(s).length>0?(c.salesmstr=s.salesmstr[0],c.salesdtl=s.salesdtl,c.setSubTotal(c.salesmstr)):(new PNotify({title:"Woops!",text:"item out of stock",type:"info"}),"keyboard"==a&&(e.qty=e.oldqty)):new PNotify({title:"Woops!",text:"item status is inactive",type:"info"}):c.transactionIsClose(),r.configLoadingPOSTransactions("off",c)},function(t){new PNotify({title:"Error(s) found!",text:"please see logs for details",type:"error"}),console.log(t.data),r.configLoadingPOSTransactions("off",c)}))},c.transactionIsClose=function(){-1!=c.pk_salesmstr&&$("#pk_salesmstr option[value="+c.pk_salesmstr+"] ").remove(),PNotify.removeAll(),new PNotify({title:"Woops!",text:"transaction is close",type:"info"}),c.init()},c.isOpenTransaction=function(){return null!=c.pk_salesmstr&&-1!=c.pk_salesmstr&&null!=c.pk_salesmstr||(PNotify.removeAll(),new PNotify({title:"Woops!",text:"please select transaction first",type:"info"}),!1)},c.setSelect2Value=function(t,s){switch(s){case"fk_persons":c.fk_persons=t.fk_persons,c.payername=t.payername,$("#fk_persons").empty().append('<option value="'+c.fk_persons+'">'+c.payername+"</option>").val(c.fk_persons).trigger("change"),null==c.fk_persons&&$("#fk_persons").empty().append('<option value="-1">*Walk-in Customer*</option>').val(-1).trigger("change");break;case"fk_discounts":c.fk_discounts=t.fk_discounts,c.discountname=t.discountname,c.discrate=t.discrate,$("#fk_discounts").empty().append('<option value="'+c.fk_discounts+'">'+c.discountname+"</option>").val(c.fk_discounts).trigger("change"),null==c.fk_discounts&&(c.discountname="*Not Applicable*",$("#fk_discounts").empty().append('<option value="-1">*Not Applicable*</option>').val(-1).trigger("change"))}},c.setSubTotal=function(t){c.subtotal=t.totalamount,c.totaltax=t.vatamount,c.totaldiscount=t.totaldisc,c.netamount=t.netamount},c.ValidateNumber=function(t,s){switch(s){case"qty":(isNaN(t.qty)||null==t.qty)&&(t.qty=t.oldqty),t.qty!=t.oldqty&&(t.pk_products=t.fk_products,c.AddItem(t,t.qty,"keyboard"));break;case"payment":(isNaN(c.paymentamount)||null==c.paymentamount)&&(c.paymentamount=1),c.changeamount=-1*(parseFloat(c.balanceamount)-parseFloat(c.paymentamount))}},c.RemoveItem=function(e){c.issubmitting||c.isOpenTransaction()&&(PNotify.removeAll(),r.configLoadingPOSTransactions("on",c),t.put(s+"/removeitems/"+c.pk_salesmstr,{fk_products:e.fk_products}).then(function(t){var s=t.data;"no transaction"!=s?"object"==typeof s&&Object.keys(s).length>0&&(c.salesmstr=s.salesmstr[0],c.salesdtl=s.salesdtl,c.setSubTotal(c.salesmstr)):c.transactionIsClose(),r.configLoadingPOSTransactions("off",c)},function(t){new PNotify({title:"Error(s) found!",text:"please see logs for details",type:"error"}),console.log(t.data),r.configLoadingPOSTransactions("off",c)}))},c.CancelTransaction=function(){!c.issubmitting&&(PNotify.removeAll(),c.isOpenTransaction())&&(c.selectedID=c.pk_salesmstr,c.selectedStat="",c.form_title="cancel",e.PNotifyConfirm(c,t,o,function(){r.configLoadingPOSTransactions("on",c),t.put(s+"/delete/"+c.pk_salesmstr,{}).then(function(t){t.data,$("#pk_salesmstr option[value="+c.pk_salesmstr+"] ").remove(),new PNotify({title:"Successful!",text:"Transaction complete",type:"success"}),c.init(),r.configLoadingPOSTransactions("off",c)},function(t){o.state(t.data),r.configLoadingPOSTransactions("off",c)})}))},c.ShowPaymentModal=function(){PNotify.removeAll(),c.issubmitting||c.isOpenTransaction()&&(0!=c.salesdtl.length?l.ShowPaymentsModal(c):new PNotify({title:"Woops!",text:"transaction is empty",type:"info"}))},$("#ajaxmodalfootersubmit").click(function(){var e=s+"/payments/"+c.pk_salesmstr;l.SubmitAjaxModal(c,r,e,t,1)}),c.ShowReceiptModal=function(){$("#receiptModal").modal("show")},$("#ajaxmodalprintreceipt").click(function(){$("#printarea").printThis()}),setTimeout(c.loadDependencies,1e3)}]);